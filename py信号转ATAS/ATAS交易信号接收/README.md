# ATAS外部信号接收策略

这是一个ATAS策略，用于通过WebSocket接收来自Python服务的交易信号并自动执行交易。

## 功能特性

- ✅ 通过WebSocket客户端连接到Python服务的WebSocket服务器接收交易信号
- ✅ 在策略参数面板中控制WebSocket客户端开关
- ✅ 自动重连机制（连接断开后自动重连）
- ✅ 自动执行买入/卖出交易
- ✅ 支持品种匹配验证
- ✅ 支持使用信号价格或市价交易
- ✅ 自动处理反向持仓（平仓后开新仓）

## 信号格式

策略接收的JSON信号格式如下：

```json
{
    "ticker": "品种名称（可选）",
    "action": "buy 或 sell",
    "price": 价格（可选，数字）,
    "interval": 周期分钟数（可选，整数）
}
```

## 策略参数

在ATAS策略参数设置面板中可以配置以下参数：

### 信号接收设置
- **启用信号接收**：开启/关闭WebSocket客户端连接（默认：开启）
- **WebSocket服务器地址**：Python WebSocket服务器的地址（默认：localhost）
- **WebSocket端口**：Python WebSocket服务器的端口（默认：8765）

### 交易设置
- **交易数量**：每次交易的手数（默认：1）
- **使用信号价格**：是否使用信号中的价格，否则使用市价（默认：否）

## 编译和部署

### 1. 编译策略

1. 在Visual Studio中创建新的C#类库项目（.NET Framework 4.7.2或更高版本）
2. 添加ATAS策略库的引用（通常位于ATAS安装目录）
3. 将 `ExternalSignalStrategy.cs` 添加到项目中
4. 编译项目生成DLL文件

### 2. 部署策略

1. 将编译好的DLL文件复制到 `Documents\ATAS\Strategies` 目录
2. 重启ATAS平台
3. 在图表上右键 -> 添加策略 -> 选择"外部信号接收策略"

## 使用流程

1. **启动Python信号转发服务**
   - 运行 `py信号转发服务/app.py`
   - 服务会启动两个服务：
     - HTTP服务器：监听5000端口，接收TradingView的POST请求
     - WebSocket服务器：监听8765端口（默认），等待ATAS客户端连接

2. **在ATAS中添加策略**
   - 在图表上添加"外部信号接收策略"
   - 在策略参数面板中：
     - 确保"启用信号接收"已勾选
     - 确认"WebSocket服务器地址"为localhost（如果Python服务在同一台机器）
     - 确认"WebSocket端口"为8765（与Python服务配置一致）
     - 设置交易数量和其他参数

3. **启动策略**
   - 点击策略的"启动"按钮
   - 策略会自动连接到Python服务的WebSocket服务器
   - 如果连接失败，策略会自动重试（每5秒重连一次）

4. **发送信号**
   - TradingView发送HTTP POST请求到Python服务（端口5000）
   - Python服务接收信号后，通过WebSocket广播给所有连接的ATAS客户端
   - ATAS策略接收到信号后会自动执行交易

## 注意事项

1. **端口冲突**：确保WebSocket端口（默认8765）未被其他程序占用
2. **防火墙设置**：如果Python服务运行在不同机器，需要配置防火墙允许WebSocket连接
3. **品种匹配**：如果信号中包含ticker字段，策略会验证是否与当前图表品种匹配
4. **持仓管理**：策略会自动处理反向持仓，先平仓再开新仓

## 日志

策略运行过程中的日志会显示在ATAS的日志窗口中，包括：
- WebSocket服务器启动/停止状态
- 接收到的信号信息
- 交易执行结果
- 错误信息

## 故障排查

### WebSocket客户端无法连接
- 确认Python服务正在运行
- 确认Python服务的WebSocket服务器已启动（查看Python服务日志）
- 检查WebSocket服务器地址和端口是否正确
- 检查防火墙是否阻止连接
- 查看ATAS日志窗口的错误信息

### 无法接收信号
- 确认Python服务正在运行
- 确认Python服务中的WS_ENABLED环境变量为true
- 确认Python服务中的WS_PORT与策略中的端口一致
- 确认ATAS策略已成功连接到WebSocket服务器（查看日志）
- 检查网络连接

### 连接频繁断开
- 检查网络稳定性
- 检查Python服务是否正常运行
- 策略会自动重连，如果持续失败，检查服务器地址和端口

### 交易未执行
- 检查信号格式是否正确
- 检查品种是否匹配（如果信号包含ticker）
- 检查账户是否有足够资金
- 查看ATAS日志窗口的详细信息

