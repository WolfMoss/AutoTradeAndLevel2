# 数据导出数量说明

## 概述

项目导出两种CSV文件：
1. **主数据文件**（OrderFlowData_Main.csv）：每个K线Bar一条记录
2. **Footprint数据文件**（OrderFlowData_Footprint.csv）：每个K线Bar可能有多条记录（每个价格层级一条）

## 主数据文件记录数

### 决定因素

主数据文件的记录数 = **图表上可见的K线Bar数量**

### 影响因素

#### 1. `OnlyRealTimeData` 参数（仅导出实时数据）
- **默认值**：`false`
- **作用**：
  - `false`：导出所有历史K线 + 实时K线
  - `true`：只导出最后一根实时K线（忽略所有历史数据）

```196:198:OrderFlowDataExporter.cs
            // 如果只导出实时数据，则只处理最后一根K线
            if (OnlyRealTimeData && bar < CurrentBar - 1)
                return;
```

#### 2. `ClearOnStart` 参数（启动时清空文件）
- **默认值**：`true`
- **作用**：
  - `true`：每次启动指标时，清空之前的导出文件，重新开始
  - `false`：保留之前的导出数据，追加新数据

```153:170:OrderFlowDataExporter.cs
            if (ClearOnStart)
            {
                try
                {
                    if (File.Exists(ExportFilePath))
                    {
                        File.Delete(ExportFilePath);
                    }
                    if (File.Exists(FootprintExportFilePath))
                    {
                        File.Delete(FootprintExportFilePath);
                    }
                }
                catch (Exception ex)
                {
                    AddInfoLog($"清空文件失败: {ex.Message}");
                }
            }
```

#### 3. 重复导出控制
- 对于历史K线（`bar < CurrentBar - 1`）：每个Bar只导出一次，避免重复
- 对于实时K线（最后一根）：允许重复导出以更新数据

```200:205:OrderFlowDataExporter.cs
            // 避免重复导出同一根K线
            // 修改：对于历史K线，避免重复导出；对于实时K线（最后一根），允许重复导出以更新数据
            if (bar == _lastExportedBar && bar < CurrentBar - 1 && 
                InstrumentInfo?.Instrument != null && 
                InstrumentInfo.Instrument == _lastExportedSymbol)
                return;
```

### 计算公式

```
主数据记录数 = 图表上的K线Bar数量
（如果 OnlyRealTimeData = true，则只有1条记录）
```

## Footprint数据文件记录数

### 决定因素

Footprint数据文件的记录数 = **所有Bar的价格层级数量之和**

### 影响因素

#### 1. `ExportFootprintDetails` 参数（导出Footprint详情）
- **默认值**：`true`
- **作用**：
  - `true`：导出Footprint详细数据
  - `false`：不导出Footprint数据（文件为空或不存在）

```300:320:OrderFlowDataExporter.cs
            // 提取Footprint详情（可选）
            if (ExportFootprintDetails)
            {
                data.FootprintLevels = new List<FootprintLevel>();
                var priceLevels = candle.GetAllPriceLevels();
                if (priceLevels != null)
                {
                    foreach (var level in priceLevels)
                    {
                        data.FootprintLevels.Add(new FootprintLevel
                        {
                            Price = level.Price,
                            Volume = level.Volume,
                            Bid = level.Bid,
                            Ask = level.Ask,
                            Delta = level.Ask - level.Bid,
                            Ticks = level.Ticks
                        });
                    }
                }
            }
```

#### 2. 每个Bar的价格层级数量
- 由 `candle.GetAllPriceLevels()` 返回的数据决定
- 每个价格层级对应一条Footprint记录
- 价格层级数量取决于：
  - K线的价格范围（High - Low）
  - 价格精度（Tick Size）
  - 是否有成交的价格层级

### 计算公式

```
Footprint记录数 = Σ(每个Bar的价格层级数量)
（如果 ExportFootprintDetails = false，则为0）
```

## 字段数量

### 主数据文件字段数

基础字段（19个）：
- Symbol, BarIndex, Time, LastTime
- Open, High, Low, Close, Volume
- Bid, Ask, Delta, Betweens
- MaxDelta, MinDelta
- OI, MaxOI, MinOI
- Ticks

可选字段：
- **POC字段**（4个）：如果 `ExportPOC = true`
  - POCPrice, POCVolume, POCBid, POCAsk
- **Value Area字段**（3个）：如果 `ExportValueArea = true`
  - VAH, VAL, VWAP
- **Max Delta字段**（4个）：如果 `ExportMaxDeltaInfo = true`
  - MaxPosDeltaPrice, MaxPosDeltaVolume
  - MaxNegDeltaPrice, MaxNegDeltaVolume

**总字段数** = 19 + (ExportPOC ? 4 : 0) + (ExportValueArea ? 3 : 0) + (ExportMaxDeltaInfo ? 4 : 0)

### Footprint数据文件字段数

固定字段（9个）：
- Symbol, BarIndex, Time
- LevelPrice, LevelVolume, LevelBid, LevelAsk, LevelDelta, LevelTicks

## 数据导出流程

```
1. ATAS调用 OnCalculate(bar) 对每个Bar进行计算
   ↓
2. 检查 OnlyRealTimeData：如果为true且bar不是最后一根，跳过
   ↓
3. 检查重复导出：如果是历史Bar且已导出过，跳过
   ↓
4. 提取数据：ExtractOrderFlowData(bar, candle)
   - 提取基础数据（每个Bar 1条主数据记录）
   - 如果 ExportFootprintDetails = true，提取价格层级数据（每个Bar可能多条Footprint记录）
   ↓
5. 导出到CSV文件
   - 主数据：1条记录
   - Footprint数据：N条记录（N = 该Bar的价格层级数量）
```

## 示例

假设：
- 图表上有100根K线
- `OnlyRealTimeData = false`
- `ExportFootprintDetails = true`
- 平均每个Bar有20个价格层级

**主数据文件**：
- 记录数：100条（每个Bar 1条）

**Footprint数据文件**：
- 记录数：约2000条（100个Bar × 20个价格层级）

## 注意事项

1. **实时K线会重复更新**：最后一根K线（实时K线）会随着数据更新而重复导出，覆盖之前的数据
2. **字段数量必须一致**：首次导出和增量更新时，字段数量必须匹配，否则会导致字段不对齐（已修复）
3. **价格层级数量不固定**：不同Bar的价格层级数量可能不同，取决于该Bar的价格波动范围
4. **文件大小**：Footprint数据文件通常比主数据文件大很多，因为每个Bar可能有多条记录

